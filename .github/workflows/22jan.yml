name: CI/CD Pipeline with Security & IIS Deployment

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test-artifact:
    runs-on: windows-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # SECURITY SCANNING - Added
      - name: Secret Scanning
        shell: pwsh
        run: |
          Write-Host "=== SECURITY SCAN: Checking for hardcoded secrets ===" -ForegroundColor Yellow
          $secretsPattern = @(
            'password\s*=\s*["'']?[^"'']*["'']?',
            'connectionString.*=.*["'']',
            'api[_-]?key\s*=\s*["'']?[^"'']*["'']?',
            'secret[_-]?key\s*=\s*["'']?[^"'']*["'']?',
            'token\s*=\s*["'']?[^"'']*["'']?'
          )
          
          $foundSecrets = $false
          foreach ($pattern in $secretsPattern) {
            $matches = Select-String -Path "**/*.cs,**/*.config,**/*.json,**/*.cshtml" -Pattern $pattern -List
            if ($matches) {
              Write-Warning "Potential secret found with pattern: $pattern"
              $matches | ForEach-Object { Write-Warning "  File: $($_.Path):$($_.LineNumber)" }
              $foundSecrets = $true
            }
          }
          
          if ($foundSecrets) {
            Write-Error "❌ Potential secrets detected. Remove hardcoded credentials."
            exit 1
          }
          Write-Host "✅ No hardcoded secrets found" -ForegroundColor Green

      # Setup NuGet and restore packages
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore PartsUnlimited.sln

      # NUGET SECURITY AUDIT - Added
      - name: NuGet Security Audit
        shell: pwsh
        run: |
          Write-Host "=== SECURITY SCAN: Checking NuGet packages ===" -ForegroundColor Yellow
          nuget list "PartsUnlimited.*" -Prerelease | Out-Host
          
          # Check for known vulnerable packages
          $vulnerablePackages = @(
            "Microsoft.AspNetCore.*",
            "Newtonsoft.Json",
            "System.*"
          )
          
          $installed = nuget list "PartsUnlimited.*" -Prerelease
          foreach ($pkg in $vulnerablePackages) {
            if ($installed -match $pkg) {
              Write-Warning "Package found: $pkg - Ensure latest version"
            }
          }
          Write-Host "✅ NuGet package scan completed" -ForegroundColor Green

      # Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # CODE ANALYSIS - Added
      - name: Code Analysis
        shell: pwsh
        run: |
          Write-Host "=== CODE ANALYSIS: Running build with analysis ===" -ForegroundColor Yellow
          msbuild PartsUnlimited.sln `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:RunCodeAnalysis=true `
            /p:CodeAnalysisRuleSet=MinimumRecommendedRules.ruleset `
            /verbosity:minimal
          Write-Host "✅ Code analysis completed" -ForegroundColor Green

      # Build solution & publish website
      - name: Build & Publish Website
        run: |
          # Build the web project and publish to artifact folder
          msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl=..\..\artifact `
            /p:DeployTarget=WebPublish

      # Build test projects
      - name: Build Test Projects
        run: |
          msbuild test\PartsUnlimited.UnitTests\PartsUnlimited.UnitTests.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU
        continue-on-error: true

      # Run MSTest unit tests
      - name: Run Unit Tests
        shell: pwsh
        run: |
          # Locate vstest.console.exe dynamically
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vstest = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find **\vstest.console.exe |
            Select-Object -First 1
          Write-Host "Using vstest: $vstest"
          # Find and run unit test DLLs
          $testDlls = Get-ChildItem -Path "test" -Filter "*UnitTests.dll" -Recurse | 
            Where-Object { $_.FullName -like "*\bin\Release\*" } |
            Select-Object -ExpandProperty FullName
          if ($testDlls) {
            Write-Host "Found test DLLs:"
            $testDlls | ForEach-Object { Write-Host "  $_" }
            & "$vstest" $testDlls /Platform:x64 /Logger:trx
          } else {
            Write-Host "No test DLLs found"
          }
        continue-on-error: true

      # List artifact contents
      - name: List artifact folder contents
        run: |
          if (Test-Path "artifact") {
            Write-Host "Artifact folder contents:"
            Get-ChildItem artifact -Recurse | Select-Object FullName
          } else {
            Write-Host "Artifact folder not found"
          }

      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: PartsUnlimited-Web
          path: artifact

  deploy:
    needs: build-test-artifact
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      # Checkout repository to get deployment script
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: PartsUnlimited-Web
          path: ./artifacts
      
      # Display artifact structure
      - name: Display artifact structure
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Artifact Contents" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          $files = Get-ChildItem -Path ./artifacts -Recurse
          Write-Host "Total files: $($files.Count)"
          $files | Select-Object -First 10 FullName | ForEach-Object { Write-Host "  $_" }
          if ($files.Count -gt 10) {
            Write-Host "  ... and $($files.Count - 10) more files"
          }
          Write-Host ""
      
      # Deploy to IIS (ENHANCED with error handling and backup)
      - name: Deploy to IIS
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "IIS DEPLOYMENT STARTED" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n" -ForegroundColor Gray
          
          try {
            # Load IIS module
            Import-Module WebAdministration -ErrorAction Stop
            Write-Host "✅ IIS Module loaded successfully" -ForegroundColor Green
          } catch {
            Write-Host "❌ ERROR: Cannot load WebAdministration module" -ForegroundColor Red
            Write-Host "   Ensure IIS Management Tools are installed on this server" -ForegroundColor Yellow
            Write-Host "   Run: Install-WindowsFeature Web-Mgmt-Tools" -ForegroundColor Yellow
            exit 1
          }
          
          # Create backup of existing site
          $backupPath = "C:\inetpub\wwwroot\PartsUnlimited_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
          if (Test-Path "C:\inetpub\wwwroot\PartsUnlimited") {
            Write-Host "Creating backup at: $backupPath" -ForegroundColor Yellow
            try {
              Copy-Item -Path "C:\inetpub\wwwroot\PartsUnlimited" -Destination $backupPath -Recurse -Force -ErrorAction Stop
              Write-Host "✅ Backup created successfully" -ForegroundColor Green
            } catch {
              Write-Host "⚠ Warning: Could not create backup: $_" -ForegroundColor Yellow
            }
          }
          
          # Stop IIS services with verification
          Write-Host "`nStopping IIS services..." -ForegroundColor Yellow
          try {
            $appPool = Get-WebAppPool -Name "PartsUnlimitedAppPool" -ErrorAction SilentlyContinue
            if ($appPool -and $appPool.State -eq "Started") {
              Stop-WebAppPool -Name "PartsUnlimitedAppPool" -ErrorAction Stop
              Write-Host "✅ Stopped App Pool: PartsUnlimitedAppPool" -ForegroundColor Green
            } else {
              Write-Host "⚠ App Pool not found or already stopped" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "⚠ Warning: Could not stop App Pool: $_" -ForegroundColor Yellow
          }
          
          try {
            $website = Get-Website -Name "PartsUnlimited" -ErrorAction SilentlyContinue
            if ($website -and $website.State -eq "Started") {
              Stop-Website -Name "PartsUnlimited" -ErrorAction Stop
              Write-Host "✅ Stopped Website: PartsUnlimited" -ForegroundColor Green
            } else {
              Write-Host "⚠ Website not found or already stopped" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "⚠ Warning: Could not stop Website: $_" -ForegroundColor Yellow
          }
          
          Start-Sleep -Seconds 3
          
          # Deploy new files with cleanup
          Write-Host "`nDeploying new files..." -ForegroundColor Yellow
          $destination = "C:\inetpub\wwwroot\PartsUnlimited"
          
          # Ensure destination exists
          if (!(Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination -Force | Out-Null
            Write-Host "✅ Created directory: $destination" -ForegroundColor Green
          }
          
          # Clean existing files (keep web.config if exists)
          if (Test-Path $destination) {
            Write-Host "Cleaning existing files..." -ForegroundColor Gray
            $items = Get-ChildItem -Path $destination -Exclude "web.config", "appsettings*.json", "connectionstrings.config"
            if ($items) {
              $items | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "Removed $($items.Count) old files" -ForegroundColor Gray
            }
          }
          
          # Copy new files
          Write-Host "Copying new files from artifacts..." -ForegroundColor Gray
          $sourceFiles = Get-ChildItem -Path ".\artifacts" -Recurse
          Copy-Item -Path ".\artifacts\*" -Destination $destination -Recurse -Force
          Write-Host "✅ Copied $($sourceFiles.Count) files" -ForegroundColor Green
          
          # Set permissions for IIS
          Write-Host "`nSetting file permissions..." -ForegroundColor Yellow
          try {
            icacls $destination /grant "IIS_IUSRS:(OI)(CI)R" /T 2>$null
            Write-Host "✅ Permissions set for IIS_IUSRS" -ForegroundColor Green
          } catch {
            Write-Host "⚠ Could not set permissions (may require admin)" -ForegroundColor Yellow
          }
          
          # Start IIS services
          Write-Host "`nStarting IIS services..." -ForegroundColor Yellow
          try {
            Start-WebAppPool -Name "PartsUnlimitedAppPool" -ErrorAction Stop
            Write-Host "✅ Started App Pool: PartsUnlimitedAppPool" -ForegroundColor Green
          } catch {
            Write-Host "⚠ Could not start App Pool, attempting to create..." -ForegroundColor Yellow
            try {
              New-WebAppPool -Name "PartsUnlimitedAppPool" -Force
              Set-ItemProperty "IIS:\AppPools\PartsUnlimitedAppPool" managedRuntimeVersion "v4.0"
              Start-WebAppPool -Name "PartsUnlimitedAppPool"
              Write-Host "✅ Created and started new App Pool" -ForegroundColor Green
            } catch {
              Write-Host "❌ Failed to create App Pool: $_" -ForegroundColor Red
            }
          }
          
          try {
            Start-Website -Name "PartsUnlimited" -ErrorAction Stop
            Write-Host "✅ Started Website: PartsUnlimited" -ForegroundColor Green
          } catch {
            Write-Host "⚠ Could not start Website, attempting to create..." -ForegroundColor Yellow
            try {
              New-Website -Name "PartsUnlimited" -PhysicalPath $destination -ApplicationPool "PartsUnlimitedAppPool" -Port 8080 -Force
              Write-Host "✅ Created and started new Website" -ForegroundColor Green
            } catch {
              Write-Host "❌ Failed to create Website: $_" -ForegroundColor Red
            }
          }
          
          # Verify deployment
          Write-Host "`nVerifying deployment..." -ForegroundColor Yellow
          Start-Sleep -Seconds 5
          
          $appPoolState = Get-WebAppPoolState -Name "PartsUnlimitedAppPool" -ErrorAction SilentlyContinue
          $websiteState = Get-WebsiteState -Name "PartsUnlimited" -ErrorAction SilentlyContinue
          
          Write-Host "App Pool State: $($appPoolState.Value)" -ForegroundColor Cyan
          Write-Host "Website State: $($websiteState.Value)" -ForegroundColor Cyan
          
          Write-Host "`n" + "="*50 -ForegroundColor Green
          Write-Host "✅ DEPLOYMENT COMPLETE" -ForegroundColor Green
          Write-Host "="*50 -ForegroundColor Green
          Write-Host "Site URL: http://localhost:8080" -ForegroundColor Cyan
          Write-Host "Backup: $backupPath" -ForegroundColor Gray
          Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
      
      # Verify deployment (ENHANCED with health check)
      - name: Verify deployment
        shell: pwsh
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "HEALTH CHECK" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $url = "http://localhost:8080"
          $maxRetries = 12
          $retryDelay = 5
          
          Write-Host "Testing website availability at: $url" -ForegroundColor Yellow
          
          for ($i = 1; $i -le $maxRetries; $i++) {
            Write-Host "Attempt $i/$maxRetries..." -ForegroundColor Gray
            
            try {
              $response = Invoke-WebRequest -Uri $url -Method Head -TimeoutSec 10 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ SUCCESS: Website responding (HTTP $($response.StatusCode))" -ForegroundColor Green
                
                # Additional check: Verify site content
                try {
                  $content = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                  if ($content.Content.Length -gt 0) {
                    Write-Host "✅ Content loaded successfully ($($content.Content.Length) bytes)" -ForegroundColor Green
                  }
                } catch {
                  Write-Host "⚠ Could not fetch content, but site is responding" -ForegroundColor Yellow
                }
                
                exit 0
              }
            } catch [System.Net.WebException] {
              Write-Host "  Status: $($_.Exception.Response.StatusCode.value__)" -ForegroundColor Yellow
            } catch {
              Write-Host "  Waiting... ($($_.Exception.Message))" -ForegroundColor Yellow
            }
            
            if ($i -lt $maxRetries) {
              Start-Sleep -Seconds $retryDelay
            }
          }
          
          Write-Host "`n❌ FAILED: Website did not respond after $maxRetries attempts" -ForegroundColor Red
          Write-Host "`nTroubleshooting steps:" -ForegroundColor Yellow
          Write-Host "1. Check IIS Manager for errors" -ForegroundColor Gray
          Write-Host "2. Verify App Pool is running" -ForegroundColor Gray
          Write-Host "3. Check Windows Event Viewer" -ForegroundColor Gray
          Write-Host "4. Restore backup from: $backupPath" -ForegroundColor Gray
          
          exit 1
