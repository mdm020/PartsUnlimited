name: CI/CD - Build and Deploy to IIS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # allows manual run

jobs:
  build-and-deploy:
    runs-on: windows-latest
    # Use self-hosted for deployment step if IIS is local
    # runs-on: self-hosted

    env:
      IIS_APP_POOL_NAME: ${{ secrets.IIS_APP_POOL_NAME }}
      IIS_SITE_PATH: ${{ secrets.IIS_SITE_PATH }}
      IIS_SITE_URL: ${{ secrets.IIS_SITE_URL }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup NuGet
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      # 3Ô∏è‚É£ Restore NuGet packages
      - name: Restore NuGet packages
        run: nuget restore PartsUnlimited.sln

      # 4Ô∏è‚É£ Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 5Ô∏è‚É£ Build solution and publish website
      - name: Build & Publish Website
        run: |
          mkdir artifact
          msbuild PartsUnlimited.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl=artifact `
            /p:DeployTarget=WebPublish `
            /p:OutDir=artifact\

      # 6Ô∏è‚É£ Run MSTest unit tests (excluding Selenium)
      - name: Run Unit Tests
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vstest = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find **\vstest.console.exe | Select-Object -First 1
          Write-Host "Using vstest: $vstest"
          & "$vstest" **\bin\Release\*UnitTests.dll /Platform:x64

      # 7Ô∏è‚É£ Stop IIS App Pool
      - name: Stop IIS Application Pool
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        shell: pwsh
        run: |
          Import-Module WebAdministration
          Write-Host "Stopping App Pool: $env:IIS_APP_POOL_NAME"
          Stop-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 8Ô∏è‚É£ Backup existing site (optional)
      - name: Backup existing IIS site
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        shell: pwsh
        run: |
          $destination = $env:IIS_SITE_PATH
          if (Test-Path $destination) {
              $backupPath = "$destination-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item -Path $destination -Destination $backupPath -Recurse -Force
              Write-Host "Backup created at: $backupPath"
          }

      # 9Ô∏è‚É£ Deploy artifact to IIS
      - name: Deploy to IIS
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        shell: pwsh
        run: |
          $source = "artifact\*"
          $destination = $env:IIS_SITE_PATH
          Write-Host "Deploying from: $source"
          Write-Host "Deploying to: $destination"
          Copy-Item -Path $source -Destination $destination -Recurse -Force
          Write-Host "‚úÖ Deployment completed successfully"

      # üîü Start IIS App Pool
      - name: Start IIS Application Pool
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        shell: pwsh
        run: |
          Import-Module WebAdministration
          Write-Host "Starting App Pool: $env:IIS_APP_POOL_NAME"
          Start-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 1Ô∏è‚É£1Ô∏è‚É£ Verify deployment
      - name: Verify deployment
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        shell: pwsh
        run: |
          $url = $env:IIS_SITE_URL
          Write-Host "Checking website: $url"
          try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30
              if ($response.StatusCode -eq 200) {
                  Write-Host "‚úÖ Website is responding successfully"
              } else {
                  Write-Warning "‚ö†Ô∏è Website returned status code: $($response.StatusCode)"
              }
          } catch {
              Write-Error "‚ùå Website check failed: $_"
              exit 1
          }
