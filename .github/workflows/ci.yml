name: CI Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Setup VSTest
      uses: darenm/Setup-VSTest@v1.2
      
    - name: Restore NuGet packages
      run: nuget restore PartsUnlimited.sln
      
    - name: Build solution
      run: msbuild PartsUnlimited.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployOnBuild=false /p:VisualStudioVersion=17.0 /m /v:minimal
      
    - name: List build output
      run: |
        Write-Host "Checking build output..."
        if (Test-Path "test\PartsUnlimited.UnitTests\bin\Release") {
          Get-ChildItem "test\PartsUnlimited.UnitTests\bin\Release" -Recurse | Select-Object FullName
        } else {
          Write-Host "Release folder not found!"
        }
      continue-on-error: true
      
    - name: Run Unit Tests
      run: vstest.console.exe test\PartsUnlimited.UnitTests\bin\Release\PartsUnlimited.UnitTests.dll /Logger:trx
      continue-on-error: true
      
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Unit Test Results
        path: 'TestResults/*.trx'
        reporter: dotnet-trx
        fail-on-error: false
        fail-on-empty: false
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          src/**/bin/Release/
          !src/**/bin/Release/**/*.pdb
          !src/**/bin/Release/**/*.xml
