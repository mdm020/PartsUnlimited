name: CI Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: |
        Write-Host "Restoring NuGet packages..."
        nuget restore PartsUnlimited.sln -Verbosity detailed
      
    - name: Build Web Project
      run: |
        Write-Host "Building PartsUnlimited Website..."
        msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj /p:Configuration=Release /p:Platform=AnyCPU /p:DeployOnBuild=false /t:Build /v:minimal
      
    - name: Build Test Projects
      run: |
        Write-Host "Building Test Projects..."
        msbuild test\PartsUnlimited.UnitTests\PartsUnlimited.UnitTests.csproj /p:Configuration=Release /p:Platform=AnyCPU /t:Build /v:minimal
      continue-on-error: true
      
    - name: Verify Build Output
      run: |
        Write-Host "Web Project Output:"
        if (Test-Path "src\PartsUnlimitedWebsite\bin") {
          Get-ChildItem "src\PartsUnlimitedWebsite\bin" -Recurse -File | Select-Object FullName
        }
        Write-Host "`nTest Project Output:"
        if (Test-Path "test\PartsUnlimited.UnitTests\bin\Release") {
          Get-ChildItem "test\PartsUnlimited.UnitTests\bin\Release" -Recurse -File | Select-Object FullName
        }
      continue-on-error: true
      
    - name: Run Unit Tests
      run: |
        if (Test-Path "test\PartsUnlimited.UnitTests\bin\Release\PartsUnlimited.UnitTests.dll") {
          vstest.console.exe test\PartsUnlimited.UnitTests\bin\Release\PartsUnlimited.UnitTests.dll /Logger:trx
        } else {
          Write-Host "Test DLL not found, skipping tests"
        }
      continue-on-error: true
      
   - name: Publish Test Results
  uses: dorny/test-reporter@v1
  if: github.event.pull_request.head.repo.full_name == github.repository
  with:
    name: Unit Test Results
    path: 'TestResults/*.trx'
    reporter: dotnet-trx
    fail-on-error: false
    fail-on-empty: false
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          src/**/bin/Release/
          !src/**/bin/Release/**/*.pdb
          !src/**/bin/Release/**/*.xml
