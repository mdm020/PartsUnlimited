name: CD - Deploy to IIS

on:
  workflow_run:
    workflows: ["CI Build and Test"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      # Checkout repository to get deployment script
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Download build artifacts from CI workflow
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: PartsUnlimited-Web
          path: ./artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      # Display artifact structure
      - name: Display artifact structure
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Artifact Contents" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Get-ChildItem -Path ./artifacts -Recurse | Select-Object FullName
          Write-Host ""
      
      # Verify IIS is available
      - name: Verify IIS
        run: |
          Write-Host "Checking IIS availability..." -ForegroundColor Cyan
          $iisFeature = Get-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole
          if ($iisFeature.State -eq "Enabled") {
            Write-Host "IIS is installed and enabled" -ForegroundColor Green
          } else {
            Write-Host "IIS is not enabled. Attempting to enable..." -ForegroundColor Yellow
            Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole -All -NoRestart
          }
          
          # Import WebAdministration module
          Import-Module WebAdministration -ErrorAction Stop
          Write-Host "WebAdministration module loaded successfully" -ForegroundColor Green
      
      # Deploy to IIS
      - name: Deploy to IIS
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Starting IIS Deployment" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Site Name: $env:IIS_SITE_NAME"
          Write-Host "App Pool: $env:IIS_APP_POOL_NAME"
          Write-Host "Physical Path: $env:IIS_PHYSICAL_PATH"
          Write-Host "Port: $env:IIS_PORT"
          Write-Host ""
          
          # Execute deployment script
          .\scripts\Deploy-ToIIS.ps1 `
            -ArtifactPath ".\artifacts" `
            -SiteName $env:IIS_SITE_NAME `
            -AppPoolName $env:IIS_APP_POOL_NAME `
            -PhysicalPath $env:IIS_PHYSICAL_PATH `
            -Port ([int]$env:IIS_PORT)
        env:
          IIS_SITE_NAME: PartsUnlimited
          IIS_APP_POOL_NAME: PartsUnlimitedAppPool
          IIS_PHYSICAL_PATH: C:\inetpub\wwwroot\PartsUnlimited
          IIS_PORT: 8080
      
      # Verify deployment
      - name: Verify deployment
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Verifying Deployment" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          Import-Module WebAdministration
          
          # Check App Pool status
          $appPool = Get-WebAppPoolState -Name $env:IIS_APP_POOL_NAME
          Write-Host "App Pool Status: $($appPool.Value)" -ForegroundColor $(if($appPool.Value -eq 'Started'){'Green'}else{'Red'})
          
          # Check Website status
          $site = Get-Website -Name $env:IIS_SITE_NAME
          Write-Host "Website Status: $($site.State)" -ForegroundColor $(if($site.State -eq 'Started'){'Green'}else{'Red'})
          
          # Check if physical path exists and has files
          $fileCount = (Get-ChildItem -Path $env:IIS_PHYSICAL_PATH -File).Count
          Write-Host "Files deployed: $fileCount" -ForegroundColor Green
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Deployment Complete!" -ForegroundColor Green
          Write-Host "Website URL: http://localhost:$env:IIS_PORT" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
        env:
          IIS_SITE_NAME: PartsUnlimited
          IIS_APP_POOL_NAME: PartsUnlimitedAppPool
          IIS_PHYSICAL_PATH: C:\inetpub\wwwroot\PartsUnlimited
          IIS_PORT: 8080
