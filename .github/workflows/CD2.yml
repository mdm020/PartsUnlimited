name: CI Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test-artifact:
    runs-on: windows-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup NuGet and restore packages
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore PartsUnlimited.sln

      # Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # Build solution & publish website
      - name: Build & Publish Website
        run: |
          # Build the web project and publish to artifact folder
          msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl=..\..\artifact `
            /p:DeployTarget=WebPublish

      # Build test projects
      - name: Build Test Projects
        run: |
          msbuild test\PartsUnlimited.UnitTests\PartsUnlimited.UnitTests.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU
        continue-on-error: true

      # Run MSTest unit tests
      - name: Run Unit Tests
        shell: pwsh
        run: |
          # Locate vstest.console.exe dynamically
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vstest = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find **\vstest.console.exe |
            Select-Object -First 1

          Write-Host "Using vstest: $vstest"

          # Find and run unit test DLLs
          $testDlls = Get-ChildItem -Path "test" -Filter "*UnitTests.dll" -Recurse | 
            Where-Object { $_.FullName -like "*\bin\Release\*" } |
            Select-Object -ExpandProperty FullName

          if ($testDlls) {
            Write-Host "Found test DLLs:"
            $testDlls | ForEach-Object { Write-Host "  $_" }
            & "$vstest" $testDlls /Platform:x64 /Logger:trx
          } else {
            Write-Host "No test DLLs found"
          }
        continue-on-error: true

      # List artifact contents
      - name: List artifact folder contents
        run: |
          if (Test-Path "artifact") {
            Write-Host "Artifact folder contents:"
            Get-ChildItem artifact -Recurse | Select-Object FullName
          } else {
            Write-Host "Artifact folder not found"
          }

      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: PartsUnlimited-Web
          path: artifact

  deploy:
    needs: build-test-artifact
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      # Checkout repository to get deployment script
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: PartsUnlimited-Web
          path: ./artifacts
      
      # Display artifact structure
      - name: Display artifact structure
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Artifact Contents" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Get-ChildItem -Path ./artifacts -Recurse | Select-Object FullName
          Write-Host ""
      
      # Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "IIS Deployment Script" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Site Name: $env:IIS_SITE_NAME"
          Write-Host "App Pool: $env:IIS_APP_POOL_NAME"
          Write-Host "Physical Path: $env:IIS_PHYSICAL_PATH"
          Write-Host "Port: $env:IIS_PORT"
          Write-Host "Artifact Path: .\artifacts"
          Write-Host ""
          
          # Set variables
          $ArtifactPath = ".\artifacts"
          $SiteName = $env:IIS_SITE_NAME
          $AppPoolName = $env:IIS_APP_POOL_NAME
          $PhysicalPath = $env:IIS_PHYSICAL_PATH
          $Port = [int]$env:IIS_PORT
          
          # Import IIS module
          Import-Module WebAdministration -ErrorAction Stop
          
          # Verify artifact path exists
          if (-not (Test-Path $ArtifactPath)) {
            Write-Error "Artifact path does not exist: $ArtifactPath"
            exit 1
          }
          
          # Create physical path if it doesn't exist
          if (-not (Test-Path $PhysicalPath)) {
            Write-Host "Creating physical path: $PhysicalPath" -ForegroundColor Yellow
            New-Item -Path $PhysicalPath -ItemType Directory -Force | Out-Null
          }
          
          # Create Application Pool if it doesn't exist
          $existingAppPool = Get-WebAppPoolState -Name $AppPoolName -ErrorAction SilentlyContinue
          if (-not $existingAppPool) {
            Write-Host "Creating Application Pool: $AppPoolName" -ForegroundColor Yellow
            New-WebAppPool -Name $AppPoolName -Force
            # Configure app pool using appcmd as IIS: drive may not be available
            & "$env:SystemRoot\system32\inetsrv\appcmd.exe" set apppool $AppPoolName /managedRuntimeVersion:v4.0
            & "$env:SystemRoot\system32\inetsrv\appcmd.exe" set apppool $AppPoolName /enable32BitAppOnWin64:false
          } else {
            Write-Host "Application Pool already exists: $AppPoolName" -ForegroundColor Green
          }
          
          # Stop Application Pool
          Write-Host "Stopping Application Pool: $AppPoolName" -ForegroundColor Yellow
          $appPoolState = Get-WebAppPoolState -Name $AppPoolName
          if ($appPoolState.Value -ne "Stopped") {
            Stop-WebAppPool -Name $AppPoolName
            
            # Wait for app pool to stop
            $timeout = 30
            $elapsed = 0
            while ((Get-WebAppPoolState -Name $AppPoolName).Value -ne "Stopped" -and $elapsed -lt $timeout) {
              Start-Sleep -Seconds 1
              $elapsed++
            }
            
            if ($elapsed -ge $timeout) {
              Write-Warning "Application Pool did not stop within timeout period"
            } else {
              Write-Host "Application Pool stopped successfully" -ForegroundColor Green
            }
          }
          
          # Stop Website if it exists
          $existingSite = Get-Website -Name $SiteName -ErrorAction SilentlyContinue
          if ($existingSite) {
            Write-Host "Stopping Website: $SiteName" -ForegroundColor Yellow
            Stop-Website -Name $SiteName -ErrorAction SilentlyContinue
          }
          
          # Copy artifacts to physical path
          Write-Host "Copying artifacts from $ArtifactPath to $PhysicalPath" -ForegroundColor Yellow
          try {
            # Remove old files (keep web.config backup if exists)
            if (Test-Path "$PhysicalPath\*") {
              # Backup Web.config if it exists
              if (Test-Path "$PhysicalPath\Web.config") {
                Copy-Item "$PhysicalPath\Web.config" "$PhysicalPath\Web.config.backup" -Force
                Write-Host "Backed up Web.config" -ForegroundColor Green
              }
              
              # Remove all files except backup
              Get-ChildItem -Path $PhysicalPath -Recurse | 
                Where-Object { $_.Name -ne "Web.config.backup" } | 
                Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
            }
            
            # Copy new artifacts
            Copy-Item -Path "$ArtifactPath\*" -Destination $PhysicalPath -Recurse -Force
            Write-Host "Artifacts copied successfully" -ForegroundColor Green
          } catch {
            Write-Error "Failed to copy artifacts: $_"
            exit 1
          }
          
          $existingSite = Get-Website -Name $SiteName -ErrorAction SilentlyContinue
          if (-not $existingSite) {
            Write-Host "Creating Website: $SiteName" -ForegroundColor Yellow
            New-Website -Name $SiteName -PhysicalPath $PhysicalPath -ApplicationPool $AppPoolName -Port $Port -Force
            Write-Host "Website created successfully" -ForegroundColor Green
          } else {
            Write-Host "Website already exists, updating configuration" -ForegroundColor Yellow
            # Use appcmd to update site configuration
            & "$env:SystemRoot\system32\inetsrv\appcmd.exe" set site $SiteName /[path='/'].physicalPath:$PhysicalPath
            & "$env:SystemRoot\system32\inetsrv\appcmd.exe" set app "$SiteName/" /applicationPool:$AppPoolName
            
            # Update binding if needed
            $binding = Get-WebBinding -Name $SiteName -Port $Port -Protocol "http"
            if (-not $binding) {
              Remove-WebBinding -Name $SiteName -Protocol "http" -ErrorAction SilentlyContinue
              New-WebBinding -Name $SiteName -Protocol "http" -Port $Port -IPAddress "*"
            }
          }
          
          # Start Application Pool
          Write-Host "Starting Application Pool: $AppPoolName" -ForegroundColor Yellow
          Start-WebAppPool -Name $AppPoolName
          
          # Wait for app pool to start
          $timeout = 30
          $elapsed = 0
          while ((Get-WebAppPoolState -Name $AppPoolName).Value -ne "Started" -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds 1
            $elapsed++
          }
          
          if ((Get-WebAppPoolState -Name $AppPoolName).Value -eq "Started") {
            Write-Host "Application Pool started successfully" -ForegroundColor Green
          } else {
            Write-Warning "Application Pool did not start within timeout period"
          }
          
          # Start Website
          Write-Host "Starting Website: $SiteName" -ForegroundColor Yellow
          Start-Website -Name $SiteName
          
          # Verify website is running
          $siteState = (Get-Website -Name $SiteName).State
          if ($siteState -eq "Started") {
            Write-Host "Website started successfully" -ForegroundColor Green
          } else {
            Write-Warning "Website state: $siteState"
          }
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Deployment completed!" -ForegroundColor Green
          Write-Host "Website URL: http://localhost:$Port" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
        env:
          IIS_SITE_NAME: PartsUnlimited
          IIS_APP_POOL_NAME: PartsUnlimitedAppPool
          IIS_PHYSICAL_PATH: C:\inetpub\wwwroot\PartsUnlimited
          IIS_PORT: 8080
      
      # Verify deployment
      - name: Verify deployment
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Verifying Deployment" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          Import-Module WebAdministration
          
          # Check App Pool status
          $appPool = Get-WebAppPoolState -Name $env:IIS_APP_POOL_NAME
          Write-Host "App Pool Status: $($appPool.Value)" -ForegroundColor $(if($appPool.Value -eq 'Started'){'Green'}else{'Red'})
          
          # Check Website status
          $site = Get-Website -Name $env:IIS_SITE_NAME
          Write-Host "Website Status: $($site.State)" -ForegroundColor $(if($site.State -eq 'Started'){'Green'}else{'Red'})
          
          # Check if physical path exists and has files
          $fileCount = (Get-ChildItem -Path $env:IIS_PHYSICAL_PATH -File).Count
          Write-Host "Files deployed: $fileCount" -ForegroundColor Green
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Deployment Complete!" -ForegroundColor Green
          Write-Host "Website URL: http://localhost:$env:IIS_PORT" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
        env:
          IIS_SITE_NAME: PartsUnlimited
          IIS_APP_POOL_NAME: PartsUnlimitedAppPool
          IIS_PHYSICAL_PATH: C:\inetpub\wwwroot\PartsUnlimited
          IIS_PORT: 8080
