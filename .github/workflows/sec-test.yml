name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_CONFIGURATION: 'Release'
  BUILD_PLATFORM: 'AnyCPU'

jobs:
  # 1. BUILD AND TEST
  build:
    name: üèóÔ∏è Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: |
        nuget restore PartsUnlimited.sln -PackagesDirectory packages

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build Website
      run: |
        msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=${{ env.BUILD_PLATFORM }} `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:PublishUrl=..\..\artifact `
          /p:DeployTarget=WebPublish `
          /p:PackageRestore=true `
          /p:RestorePackagesPath=packages

    - name: Verify Build
      shell: pwsh
      run: |
        if (Test-Path "artifact") {
          $files = Get-ChildItem -Path "artifact" -Recurse -File
          Write-Host "‚úÖ Build successful - $($files.Count) files generated" -ForegroundColor Green
        } else {
          Write-Host "‚ùå Build failed - artifact folder not found" -ForegroundColor Red
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-app
        path: artifact
        retention-days: 7

  # 2. DEPLOY TO IIS
  deploy:
    name: üöÄ Deploy to Production
    needs: build
    runs-on: self-hosted
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: web-app
        path: ./deploy-files
    
    - name: Deploy to IIS
      shell: pwsh
      run: |
        $sitePath = "D:\inetpub\wwwroot\partsUnlimited"
        
        Write-Host "========================================"
        Write-Host "üöÄ DEPLOYING TO IIS"
        Write-Host "========================================"
        Write-Host "Target: $sitePath"
        Write-Host "Port: 8089"
        Write-Host ""
        
        # Create directory if needed
        if (!(Test-Path $sitePath)) {
          New-Item -ItemType Directory -Path $sitePath -Force
        }
        
        # Deploy files
        Copy-Item -Path ".\deploy-files\*" -Destination $sitePath -Recurse -Force
        
        Write-Host ""
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "‚úÖ DEPLOYMENT SUCCESSFUL"
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "Application: http://localhost:8089" -ForegroundColor Cyan
        Write-Host "Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
