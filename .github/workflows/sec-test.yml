name: Build and Deploy ASP.NET Framework App to IIS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: 'Release'
  PUBLISH_PATH: './publish'
  IIS_SITE_NAME: 'PartsUnlimited'
  APP_POOL: 'PartsUnlimitedAppPool'
  DEPLOY_PATH: 'C:\inetpub\wwwroot\PartsUnlimited'
  PORT: '8080'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    # Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Setup MSBuild (for ASP.NET Framework)
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    # Setup NuGet
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    # Restore NuGet packages
    - name: Restore NuGet packages
      run: |
        nuget restore PartsUnlimited.sln
        # OR if you have a packages.config file
        nuget restore src/PartsUnlimitedWebsite/packages.config -PackagesDirectory ./packages
      
    # Build the solution with MSBuild
    - name: Build Solution
      run: |
        msbuild PartsUnlimited.sln `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:DeployOnBuild=true `
          /p:PublishProfile=FolderProfile `
          /p:VisualStudioVersion=17.0 `
          /p:VSToolsPath="C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Microsoft\VisualStudio\v17.0" `
          /p:WebPublishMethod=FileSystem `
          /p:DeleteExistingFiles=True `
          /p:publishUrl=${{ env.PUBLISH_PATH }} `
          /verbosity:minimal
      
    # Alternative: Direct MSBuild for web project
    - name: Build Web Project
      shell: pwsh
      run: |
        $msbuildPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
        
        & $msbuildPath "src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj" `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:DeployOnBuild=true `
          /p:PublishProfile=FolderProfile `
          /p:Platform="AnyCPU" `
          /p:VisualStudioVersion=17.0 `
          /p:VSToolsPath="C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Microsoft\VisualStudio\v17.0" `
          /p:WebPublishMethod=FileSystem `
          /p:DeleteExistingFiles=True `
          /p:publishUrl=${{ env.PUBLISH_PATH }} `
          /verbosity:minimal
          
        # Check if publish was successful
        if (Test-Path "${{ env.PUBLISH_PATH }}") {
          Write-Host "‚úÖ Build successful. Files published to: ${{ env.PUBLISH_PATH }}"
          Get-ChildItem -Path "${{ env.PUBLISH_PATH }}" | Select-Object -First 10
        }
      
    # Manual publish if MSBuild fails
    - name: Manual Publish (Fallback)
      if: failure()
      shell: pwsh
      run: |
        Write-Host "Attempting manual publish..."
        
        # Create publish directory
        New-Item -Path "${{ env.PUBLISH_PATH }}" -ItemType Directory -Force
        
        # Copy web files manually (adjust paths as needed)
        Copy-Item -Path "src\PartsUnlimitedWebsite\bin\${{ env.BUILD_CONFIGURATION }}\*" -Destination "${{ env.PUBLISH_PATH }}" -Recurse -Force
        Copy-Item -Path "src\PartsUnlimitedWebsite\*.aspx" -Destination "${{ env.PUBLISH_PATH }}" -Recurse -Force
        Copy-Item -Path "src\PartsUnlimitedWebsite\*.config" -Destination "${{ env.PUBLISH_PATH }}" -Force
        Copy-Item -Path "src\PartsUnlimitedWebsite\Content\*" -Destination "${{ env.PUBLISH_PATH }}\Content" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "src\PartsUnlimitedWebsite\Scripts\*" -Destination "${{ env.PUBLISH_PATH }}\Scripts" -Recurse -Force -ErrorAction SilentlyContinue
        
        Write-Host "üìÅ Published files:"
        Get-ChildItem -Path "${{ env.PUBLISH_PATH }}" -Recurse | Select-Object -First 20
      
    # Deploy to IIS
    - name: Deploy to IIS
      shell: pwsh
      run: |
        Write-Host "üöÄ Starting IIS Deployment..."
        
        # Stop IIS services if running
        try {
          Stop-Website -Name "${{ env.IIS_SITE_NAME }}" -ErrorAction SilentlyContinue
          Write-Host "üì¥ Website stopped"
        } catch {
          Write-Host "‚ÑπÔ∏è Website not running or doesn't exist"
        }
        
        try {
          Stop-WebAppPool -Name "${{ env.APP_POOL }}" -ErrorAction SilentlyContinue
          Write-Host "üì¥ Application pool stopped"
        } catch {
          Write-Host "‚ÑπÔ∏è Application pool not running or doesn't exist"
        }
        
        Start-Sleep -Seconds 2
        
        # Ensure deployment directory exists
        if (!(Test-Path "${{ env.DEPLOY_PATH }}")) {
          New-Item -Path "${{ env.DEPLOY_PATH }}" -ItemType Directory -Force
          Write-Host "üìÅ Created deployment directory"
        } else {
          # Backup current files
          $backupPath = "C:\Backups\PartsUnlimited_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
          Copy-Item -Path "${{ env.DEPLOY_PATH }}\*" -Destination $backupPath -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üíæ Backup created at: $backupPath"
          
          # Clean deployment directory
          Remove-Item -Path "${{ env.DEPLOY_PATH }}\*" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üßπ Cleaned deployment directory"
        }
        
        # Copy published files
        if (Test-Path "${{ env.PUBLISH_PATH }}") {
          Copy-Item -Path "${{ env.PUBLISH_PATH }}\*" -Destination "${{ env.DEPLOY_PATH }}" -Recurse -Force
          Write-Host "üìÇ Copied application files"
        } else {
          Write-Host "‚ö†Ô∏è  Publish directory not found. Creating minimal structure..."
          # Create minimal web.config if needed
          $webConfig = @"
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.web>
    <compilation debug="false" targetFramework="4.8" />
    <httpRuntime targetFramework="4.8" />
  </system.web>
</configuration>
"@
          $webConfig | Out-File -FilePath "${{ env.DEPLOY_PATH }}\web.config" -Encoding UTF8
        }
        
        # Configure IIS Website
        $site = Get-Website -Name "${{ env.IIS_SITE_NAME }}" -ErrorAction SilentlyContinue
        
        if (!$site) {
          Write-Host "üåê Creating new website..."
          New-Website -Name "${{ env.IIS_SITE_NAME }}" `
            -Port ${{ env.PORT }} `
            -PhysicalPath "${{ env.DEPLOY_PATH }}" `
            -ApplicationPool "${{ env.APP_POOL }}"
        } else {
          Write-Host "üåê Updating existing website..."
          Set-ItemProperty "IIS:\Sites\${{ env.IIS_SITE_NAME }}" `
            -Name physicalPath `
            -Value "${{ env.DEPLOY_PATH }}"
          Set-ItemProperty "IIS:\Sites\${{ env.IIS_SITE_NAME }}" `
            -Name bindings `
            -Value @{protocol="http";bindingInformation="*:${{ env.PORT }}:"}
        }
        
        # Configure Application Pool
        $pool = Get-WebAppPool -Name "${{ env.APP_POOL }}" -ErrorAction SilentlyContinue
        
        if (!$pool) {
          Write-Host "‚öôÔ∏è Creating application pool..."
          New-WebAppPool -Name "${{ env.APP_POOL }}"
        }
        
        # Configure app pool for .NET Framework 4.8
        Set-ItemProperty "IIS:\AppPools\${{ env.APP_POOL }}" `
          -Name managedRuntimeVersion `
          -Value "v4.0"
        Set-ItemProperty "IIS:\AppPools\${{ env.APP_POOL }}" `
          -Name processModel.identityType `
          -Value "ApplicationPoolIdentity"
        Set-ItemProperty "IIS:\AppPools\${{ env.APP_POOL }}" `
          -Name autoStart `
          -Value $true
        
        # Start services
        Write-Host "‚ñ∂Ô∏è Starting application pool..."
        Start-WebAppPool -Name "${{ env.APP_POOL }}"
        
        Write-Host "‚ñ∂Ô∏è Starting website..."
        Start-Website -Name "${{ env.IIS_SITE_NAME }}"
        
        Write-Host "‚úÖ Deployment completed!"
        Write-Host "üîó Application URL: http://localhost:${{ env.PORT }}"
        
        # Health check
        Write-Host "üè• Performing health check..."
        Start-Sleep -Seconds 10
        
        $maxRetries = 5
        for ($i = 1; $i -le $maxRetries; $i++) {
          try {
            Write-Host "Attempt $i of $maxRetries..."
            $response = Invoke-WebRequest -Uri "http://localhost:${{ env.PORT }}" -UseBasicParsing -TimeoutSec 10
            
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ Application is healthy and responding!"
              break
            }
          } catch {
            Write-Host "Attempt $i failed"
            if ($i -lt $maxRetries) {
              Start-Sleep -Seconds 5
            }
          }
        }
        
    # Upload artifacts for debugging
    - name: Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          ${{ env.PUBLISH_PATH }}
        retention-days: 7
