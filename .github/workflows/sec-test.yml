name: CI/CD Pipeline with Security

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # 1. SECURITY: CodeQL (for .NET Framework - different approach)
  security-scan:
    name: üîí Security Scan
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Initialize CodeQL (C# only)
      uses: github/codeql-action/init@v3
      with:
        languages: csharp
        # Use autobuild for .NET Framework
        build-mode: autobuild
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # 2. CI: Build and Test (.NET Framework style)
  ci:
    name: üèóÔ∏è Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    # RESTORE ALL PACKAGES FIRST (critical for .NET Framework)
    - name: Restore NuGet packages
      shell: pwsh
      run: |
        # Restore for all projects
        nuget restore PartsUnlimited.sln
        nuget restore src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj
        nuget restore test\PartsUnlimited.UnitTests\PartsUnlimited.UnitTests.csproj
        nuget restore test\FabrikamFiber.SeleniumTests\FabrikamFiber.SeleniumTests.csproj

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # BUILD WEB PROJECT
    - name: Build Website
      run: |
        msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:PublishUrl=..\..\artifact `
          /p:DeployTarget=WebPublish `
          /p:VisualStudioVersion=16.0 `
          /p:VSToolsPath="C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Microsoft\VisualStudio\v16.0"

    # BUILD TEST PROJECTS
    - name: Build Test Projects
      shell: pwsh
      run: |
        # Build unit tests
        msbuild test\PartsUnlimited.UnitTests\PartsUnlimited.UnitTests.csproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:VisualStudioVersion=16.0
        
        # Build selenium tests (optional)
        msbuild test\FabrikamFiber.SeleniumTests\FabrikamFiber.SeleniumTests.csproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:VisualStudioVersion=16.0
        continue-on-error: true

    # RUN UNIT TESTS
    - name: Run Unit Tests
      shell: pwsh
      run: |
        $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vstest = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find **\vstest.console.exe | Select-Object -First 1
        
        # Find unit test DLLs
        $testDlls = Get-ChildItem -Path "test" -Filter "*UnitTests.dll" -Recurse | 
          Where-Object { $_.FullName -like "*\bin\Release\*" } |
          Select-Object -ExpandProperty FullName
        
        if ($testDlls) {
          & "$vstest" $testDlls /Platform:x64 /Logger:trx
        } else {
          Write-Host "No test DLLs found - skipping tests"
        }
      continue-on-error: true

    # VERIFY ARTIFACT
    - name: Verify Artifact
      shell: pwsh
      run: |
        if (Test-Path "artifact") {
          Write-Host "‚úÖ Artifact created successfully"
          $files = Get-ChildItem -Path "artifact" -Recurse | Measure-Object
          Write-Host "Files in artifact: $($files.Count)"
        } else {
          Write-Host "‚ùå Artifact folder not found"
          exit 1
        }

    # UPLOAD ARTIFACT
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-app
        path: artifact
        retention-days: 7

  # 3. CD: Deploy
  cd:
    name: üöÄ Deploy to Production
    runs-on: self-hosted
    needs: ci
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: web-app
        path: ./deploy-artifacts
    
    - name: Deploy to IIS
      shell: pwsh
      run: |
        $sitePath = "D:\inetpub\wwwroot\partsUnlimited"
        
        Write-Host "üöÄ Deploying to: $sitePath"
        
        # Backup existing (optional)
        $backupPath = "${sitePath}_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
        if (Test-Path $sitePath -PathType Container) {
          Copy-Item -Path $sitePath -Destination $backupPath -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üì¶ Backup: $backupPath"
        }
        
        # Create directory if needed
        if (!(Test-Path $sitePath)) {
          New-Item -ItemType Directory -Path $sitePath -Force
        }
        
        # Deploy
        Copy-Item -Path ".\deploy-artifacts\*" -Destination $sitePath -Recurse -Force
        
        Write-Host "‚úÖ Deployment completed!"
        Write-Host "üåê http://localhost:8089"
