name: CD - Deploy to IIS

on:
  workflow_run:
    workflows: ["CI Build and Test"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: nuget restore PartsUnlimited.sln
      
    - name: Build solution for deployment
      run: msbuild src/PartsUnlimitedWebsite/PartsUnlimitedWebsite.csproj /p:Configuration=Release /p:DeployOnBuild=true /p:PublishProfile=FolderProfile /p:OutputPath=bin\Release\ /p:WebPublishMethod=FileSystem /p:publishUrl=publish
      
    - name: Stop IIS Application Pool
      run: |
        Import-Module WebAdministration
        Stop-WebAppPool -Name "${{ secrets.IIS_APP_POOL_NAME }}"
        Start-Sleep -Seconds 5
      continue-on-error: true
      
    - name: Deploy to IIS
      run: |
        $source = "src\PartsUnlimitedWebsite\publish\*"
        $destination = "${{ secrets.IIS_SITE_PATH }}"
        
        Write-Host "Deploying from: $source"
        Write-Host "Deploying to: $destination"
        
        # Backup existing deployment (optional)
        if (Test-Path $destination) {
          $backupPath = "$destination-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          Copy-Item -Path $destination -Destination $backupPath -Recurse -Force
          Write-Host "Backup created at: $backupPath"
        }
        
        # Copy files to IIS directory
        Copy-Item -Path $source -Destination $destination -Recurse -Force
        Write-Host "Deployment completed successfully"
      
    - name: Start IIS Application Pool
      run: |
        Import-Module WebAdministration
        Start-WebAppPool -Name "${{ secrets.IIS_APP_POOL_NAME }}"
        Start-Sleep -Seconds 5
      
    - name: Verify deployment
      run: |
        $url = "${{ secrets.IIS_SITE_URL }}"
        Write-Host "Checking website: $url"
        try {
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
            Write-Host "✅ Website is responding successfully"
          } else {
            Write-Warning "⚠️ Website returned status code: $($response.StatusCode)"
          }
        } catch {
          Write-Error "❌ Website check failed: $_"
          exit 1
        }
