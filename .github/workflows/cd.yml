name: CD - Deploy to IIS

on:
  workflow_dispatch:      # Manual trigger
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted   # Your Windows self-hosted runner
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      IIS_APP_POOL_NAME: PartsUnlimitedAppPool
      IIS_SITE_PATH: C:\inetpub\wwwroot\PartsUnlimited
      IIS_SITE_URL: http://localhost:8080/

    steps:
      # 1️⃣ Checkout code (needed for paths)
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Download CI artifact
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: partsunlimited-build
          path: artifact

      # 3️⃣ Stop IIS App Pool
      - name: Stop IIS App Pool
        shell: pwsh
        run: |
          Import-Module WebAdministration -ErrorAction Stop
          Write-Host "Stopping App Pool: $env:IIS_APP_POOL_NAME"
          Stop-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 4️⃣ Backup existing IIS site (optional)
      - name: Backup existing IIS site
        shell: pwsh
        run: |
          $dest = $env:IIS_SITE_PATH
          if (Test-Path $dest) {
              $backup = "$dest-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item -Path $dest -Destination $backup -Recurse -Force
              Write-Host "Backup created at: $backup"
          }

      # 5️⃣ Deploy new files
      - name: Deploy website
        shell: pwsh
        run: |
          $source = "artifact\**\*"
          $destination = $env:IIS_SITE_PATH
          if (-not (Test-Path $destination)) { mkdir $destination }
          Copy-Item -Path $source -Destination $destination -Recurse -Force
          Write-Host "✅ Deployment completed"

      # 6️⃣ Run EF6 Migrations
      - name: Apply EF database migrations
        shell: pwsh
        run: |
          $projectPath = "$PWD\src\PartsUnlimitedWebsite"
          $toolsPath = Join-Path $projectPath "packages\EntityFramework.6.6.0\tools"

          if (Test-Path "$toolsPath\Update-Database.exe") {
              Write-Host "Applying EF6 migrations..."
              & "$toolsPath\Update-Database.exe" -ProjectName PartsUnlimitedWebsite -StartUpProjectName PartsUnlimitedWebsite -Verbose
              Write-Host "✅ Database updated"
          } else {
              Write-Warning "EF tools not found at $toolsPath. Skipping migrations."
          }

      # 7️⃣ Start IIS App Pool
      - name: Start IIS App Pool
        shell: pwsh
        run: |
          Import-Module WebAdministration -ErrorAction Stop
          Write-Host "Starting App Pool: $env:IIS_APP_POOL_NAME"
          Start-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 10

      # 8️⃣ Verify website
      - name: Verify deployment
        shell: pwsh
        run: |
          $url = $env:IIS_SITE_URL
          $maxRetries = 10
          $delay = 5
          $ok = $false

          Write-Host "Checking website: $url"
          for ($i=1; $i -le $maxRetries; $i++) {
              try {
                  $res = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
                  if ($res.StatusCode -eq 200) {
                      Write-Host "✅ Website is responding"
                      $ok = $true
                      break
                  }
              } catch {
                  Write-Warning "Attempt $i: Website not reachable yet"
              }
              Start-Sleep -Seconds $delay
          }

          if (-not $ok) {
              Write-Error "❌ Website verification failed"
              exit 1
          }
