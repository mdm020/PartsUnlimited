name: CD - Deploy to IIS

# Trigger manually or after CI workflow completes
on:
  workflow_run:
    workflows: [".NET Framework CI"]   # EXACT name of your CI workflow
    types:
      - completed
  workflow_dispatch:  # manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    if: >
      github.event_name == 'workflow_dispatch' || 
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master'))

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Download artifact from CI
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: PartsUnlimited-Web
          path: artifact

      # 3️⃣ Stop IIS Application Pool
      - name: Stop IIS Application Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Write-Host "Stopping App Pool: $env:IIS_APP_POOL_NAME"
          Stop-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 4️⃣ Backup existing IIS site (optional)
      - name: Backup existing IIS site
        shell: powershell
        run: |
          $destination = "${{ secrets.IIS_SITE_PATH }}"
          if (Test-Path $destination) {
              $backupPath = "$destination-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item -Path $destination -Destination $backupPath -Recurse -Force
              Write-Host "Backup created at: $backupPath"
          }

      # 5️⃣ Deploy artifact to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "artifact\*"
          $destination = "${{ secrets.IIS_SITE_PATH }}"
          Write-Host "Deploying from: $source"
          Write-Host "Deploying to: $destination"
          Copy-Item -Path $source -Destination $destination -Recurse -Force
          Write-Host "✅ Deployment completed successfully"

      # 6️⃣ Start IIS Application Pool
      - name: Start IIS Application Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Write-Host "Starting App Pool: $env:IIS_APP_POOL_NAME"
          Start-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 7️⃣ Verify website is responding
      - name: Verify deployment
        shell: powershell
        run: |
          $url = "${{ secrets.IIS_SITE_URL }}"
          Write-Host "Checking website: $url"
          try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30
              if ($response.StatusCode -eq 200) {
                  Write-Host "✅ Website is responding successfully"
              } else {
                  Write-Warning "⚠️ Website returned status code: $($response.StatusCode)"
              }
          } catch {
              Write-Error "❌ Website check failed: $_"
              exit 1
          }
