name: CD - Deploy to IIS

on:
  workflow_run:
    workflows: [".NET Framework CI"]   # Replace with your CI workflow name
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    env:
      IIS_APP_POOL_NAME: PartsUnlimitedAppPool
      IIS_SITE_PATH: C:\inetpub\wwwroot\PartsUnlimited
      IIS_SITE_URL: http://localhost:8080/

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup NuGet
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore PartsUnlimited.sln

      # 3Ô∏è‚É£ Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 4Ô∏è‚É£ Build & Publish Website
      - name: Build & Publish Website
        run: |
          $artifactPath = "$PWD\artifact"
          mkdir $artifactPath -Force

          msbuild PartsUnlimited.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl=$artifactPath `
            /p:DeployTarget=WebPublish

          Write-Host "Published files:"
          Get-ChildItem -Path $artifactPath -Recurse

      # 5Ô∏è‚É£ Stop IIS App Pool
      - name: Stop IIS Application Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Write-Host "Stopping App Pool: $env:IIS_APP_POOL_NAME"
          Stop-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      # 6Ô∏è‚É£ Backup existing IIS site
      - name: Backup existing IIS site
        shell: powershell
        run: |
          $destination = $env:IIS_SITE_PATH
          if (Test-Path $destination) {
              $backupPath = "$destination-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item -Path $destination -Destination $backupPath -Recurse -Force -Verbose
              Write-Host "Backup created at: $backupPath"
          }

      # 7Ô∏è‚É£ Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "$PWD\artifact\*"
          $destination = $env:IIS_SITE_PATH
          Write-Host "Deploying files from $source to $destination"
          
          if (-not (Test-Path $destination)) {
              mkdir $destination
          }

          Copy-Item -Path $source -Destination $destination -Recurse -Force -Verbose
          Write-Host "‚úÖ Deployment completed successfully"

      # 8Ô∏è‚É£ Run EF Migrations
      - name: Apply EF Database Migrations
        shell: powershell
        run: |
          Write-Host "Applying EF migrations..."
          # Path to your website project (where Packages\EF Tools is)
          $projectPath = "$PWD\src\PartsUnlimitedWebsite"
          
          # Ensure PowerShell can load EF tools
          Import-Module "$projectPath\packages\EntityFramework.6.6.0\tools\EntityFramework.psd1" -Force

          # Update database
          Update-Database -ProjectName PartsUnlimitedWebsite -StartUpProjectName PartsUnlimitedWebsite -Verbose
          Write-Host "‚úÖ Database updated successfully"

      # 9Ô∏è‚É£ Start IIS App Pool
      - name: Start IIS Application Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Write-Host "Starting App Pool: $env:IIS_APP_POOL_NAME"
          Start-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 15   # give IIS some time to start

      # üîü Verify website
      - name: Verify deployment
        shell: powershell
        run: |
          $url = $env:IIS_SITE_URL
          $maxRetries = 10
          $delaySeconds = 10
          $success = $false

          Write-Host "Verifying website: $url"

          for ($i=1; $i -le $maxRetries; $i++) {
              try {
                  $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                  if ($response.StatusCode -eq 200) {
                      Write-Host "Website is responding successfully ‚úÖ"
                      $success = $true
                      break
                  } else {
                      Write-Warning "Attempt ${i}: Website returned status code $($response.StatusCode)"
                  }
              } catch {
                  Write-Warning "Attempt ${i}: Website not reachable yet"
              }
              Start-Sleep -Seconds $delaySeconds
          }

          if (-not $success) {
              Write-Error "Website verification failed after $maxRetries attempts ‚ùå"
              exit 1
          }
