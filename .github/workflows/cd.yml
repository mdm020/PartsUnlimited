name: CD - Deploy to IIS (Manual)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    env:
      IIS_APP_POOL_NAME: ${{ secrets.IIS_APP_POOL_NAME }}
      IIS_SITE_PATH: ${{ secrets.IIS_SITE_PATH }}
      IIS_SITE_URL: ${{ secrets.IIS_SITE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore PartsUnlimited.sln

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build & Publish Website
        run: |
          mkdir artifact
          msbuild PartsUnlimited.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl=artifact `
            /p:DeployTarget=WebPublish `
            /p:OutDir=artifact\

      - name: Stop IIS App Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          Stop-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      - name: Backup existing IIS site
        shell: powershell
        run: |
          $destination = $env:IIS_SITE_PATH
          if (Test-Path $destination) {
              $backupPath = "$destination-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item -Path $destination -Destination $backupPath -Recurse -Force
          }

      - name: Deploy to IIS
        shell: powershell
        run: |
          Copy-Item -Path "artifact\*" -Destination $env:IIS_SITE_PATH -Recurse -Force

      - name: Start IIS App Pool
        shell: powershell
        run: |
          Start-WebAppPool -Name $env:IIS_APP_POOL_NAME
          Start-Sleep -Seconds 5

      - name: Verify Deployment
        shell: powershell
        run: |
          try {
              $response = Invoke-WebRequest -Uri $env:IIS_SITE_URL -UseBasicParsing -TimeoutSec 30
              if ($response.StatusCode -eq 200) { Write-Host "✅ Website is responding successfully" }
              else { Write-Warning "⚠️ Website returned status code: $($response.StatusCode)" }
          } catch { Write-Error "❌ Website check failed: $_"; exit 1 }
