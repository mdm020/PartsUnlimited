name: PartsUnlimited CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  SOLUTION_PATH: './PartsUnlimited.sln'
  WEBSITE_PROJECT_PATH: './src/PartsUnlimitedWebsite/PartsUnlimitedWebsite.csproj'
  BUILD_CONFIGURATION: 'Release'
  DOTNET_VERSION: '4.8'
  IIS_SITE_NAME: 'MyDotNetApp'
  IIS_APP_POOL: 'PartsUnlimitedAppPool'
  DEPLOYMENT_PATH: 'C:\inetpub\wwwroot\PartsUnlimited'
  IIS_PORT: 8080

jobs:
  build-and-test:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: 'latest'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuild-architecture: x64

    - name: Restore packages
      run: nuget restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:DeployOnBuild=true /p:DeployDefaultTarget=WebPublish /p:WebPublishMethod=FileSystem /p:DeleteExistingFiles=True /p:publishUrl="${{ github.workspace }}\publish"

    - name: Run tests with VSTest
      shell: powershell
      run: |
        $vsTestPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe"
        if (-not (Test-Path $vsTestPath)) {
          $vsTestPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe"
        }

        if (-not (Test-Path $vsTestPath)) {
          Write-Error "VSTest.console.exe not found on this runner."
          exit 1
        }

        $testDlls = Get-ChildItem -Path "${{ github.workspace }}\test" -Filter "*Tests.dll" -Recurse |
          Where-Object { $_.FullName -like "*\bin\${{ env.BUILD_CONFIGURATION }}\*" -and $_.FullName -notlike "*\ref\*" }

        if ($testDlls.Count -eq 0) {
          Write-Warning "No test assemblies found, skipping tests."
          exit 0
        }

        & $vsTestPath $testDlls.FullName /Platform:x64

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: partsunlimited-build
        path: ${{ github.workspace }}\publish
        retention-days: 7

  deploy:
    name: Deploy to IIS
    needs: build-and-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/master'
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: partsunlimited-build
        path: ${{ env.DEPLOYMENT_PATH }}\staging

    - name: Deploy to IIS
      shell: powershell
      run: |
        Import-Module WebAdministration
        
        $appPool = "${{ env.IIS_APP_POOL }}"
        $site = "${{ env.IIS_SITE_NAME }}"
        $path = "${{ env.DEPLOYMENT_PATH }}"
        
        # Stop app pool SAFELY - check state first
        if (Test-Path "IIS:\AppPools\$appPool") {
          $state = (Get-WebAppPoolState -Name $appPool).Value
          if ($state -ne "Stopped") {
            Stop-WebAppPool $appPool
            Start-Sleep 3
          }
        }
        
        # Copy files (overwrite)
        if (Test-Path $path) { Remove-Item $path -Recurse -Force }
        New-Item -ItemType Directory -Path $path -Force
        Copy-Item "${path}\staging\*" $path -Recurse -Force
        
        # Ensure app pool exists and configure
        if (-not (Test-Path "IIS:\AppPools\$appPool")) {
          New-WebAppPool $appPool
          Set-ItemProperty "IIS:\AppPools\$appPool" "managedRuntimeVersion" "${{ env.DOTNET_VERSION }}"
        }
        Start-WebAppPool $appPool
        Start-Website $site -ErrorAction SilentlyContinue
        
        Write-Host "Deployed to http://localhost:${{ env.IIS_PORT }}"
