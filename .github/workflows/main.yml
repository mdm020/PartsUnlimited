name: Build and Deploy
on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore PartsUnlimited.sln

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # Build step
      - name: Build
        shell: pwsh
        run: |
          msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl="..\..\artifact" `
            /p:DeployTarget=WebPublish

      # Deploy step with new IIS configuration
      - name: Deploy to IIS
        shell: pwsh
        run: |
          # IIS Configuration
          $siteName = "MyDotNetApp"
          $sitePath = "D:\inetpub\wwwroot\partsUnlimited"
          $sitePort = 8089
          
          Write-Host "Starting deployment..."
          Write-Host "IIS Site: $siteName"
          Write-Host "Port: $sitePort"
          Write-Host "Path: $sitePath"
          
          # Ensure directory exists
          if (!(Test-Path $sitePath)) {
              New-Item -ItemType Directory -Path $sitePath -Force
              Write-Host "Created directory: $sitePath"
          }
          
          # Copy build artifacts
          Write-Host "Copying files from artifact folder..."
          Copy-Item -Path ".\artifact\*" -Destination $sitePath -Recurse -Force
          
          Write-Host "‚úÖ Deployment completed!"
          Write-Host "üåê Application available at: http://localhost:$sitePort"
