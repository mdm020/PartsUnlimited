name: Build and Deploy
on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore PartsUnlimited.sln

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # Build using your original configuration
      - name: Build to Artifact Folder
        shell: pwsh
        run: |
          msbuild src\PartsUnlimitedWebsite\PartsUnlimitedWebsite.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishUrl="..\..\artifact" `
            /p:DeployTarget=WebPublish
          
          Write-Host "‚úÖ Build completed"

      # Simple check of what was created
      - name: Check Build Output
        shell: pwsh
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "`nLooking for build output..."
          
          # Check for artifact folder
          if (Test-Path ".\artifact") {
              Write-Host "Found 'artifact' folder"
              $files = Get-ChildItem -Path ".\artifact" -Recurse | Measure-Object
              Write-Host "Contains $($files.Count) files"
              Get-ChildItem -Path ".\artifact" -File | Select-Object -First 5 Name
          } else {
              Write-Host "'artifact' folder not found"
          }
          
          # Also check root for any output
          Write-Host "`nChecking for any output folders..."
          Get-ChildItem -Path "." -Directory | Where-Object { $_.Name -match "artifact|publish|bin|obj" } | Select-Object Name

      # Direct copy from artifact to IIS path
      - name: Deploy to IIS
        shell: pwsh
        run: |
          $source = ".\artifact"
          $destination = "C:\inetpub\wwwroot\PartsUnlimited"
          
          if (!(Test-Path $source)) {
              Write-Host "‚ùå ERROR: Source folder '$source' not found!"
              Write-Host "Available folders in current directory:"
              Get-ChildItem -Path "." -Directory | Select-Object Name
              exit 1
          }
          
          Write-Host "Copying from $source to $destination"
          
          # Create destination if doesn't exist
          if (!(Test-Path $destination)) {
              New-Item -ItemType Directory -Path $destination -Force
              Write-Host "Created destination directory"
          }
          
          # Copy everything
          Write-Host "Starting file copy..."
          Copy-Item -Path "$source\*" -Destination $destination -Recurse -Force
          
          Write-Host "‚úÖ Successfully deployed to IIS path"
          Write-Host "üåê Application available at: http://localhost:8080"
